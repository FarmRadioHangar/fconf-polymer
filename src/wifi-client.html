<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="ip-with-mask-input.html">
<link rel="import" href="../bower_components/gold-ip-input/gold-ip-input.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<!--link rel="import" href="../bower_components/iron-ajax/iron-ajax.html"-->
<link rel="import" href="../bower_components/uniflow-polymer/state-aware.html">
<link rel="import" href="../bower_components/uniflow-polymer/action-emitter.html">

<dom-module id="wifi-client">
	<template>
		<style include="shared-styles">
			:host {
				display: block;
			}
		</style>
		<template is="dom-if" if="[[!config]]">
			<span class="error">Not configured</span> &nbsp;
		</template>
		<template is="dom-if" if="[[isModified]]">
			<span class="notification">You have unsaved changes</span>
		</template>
		<h3>connect to WPA access point:</h3>
		<paper-input label="SSID" value="{{model.ssid}}"></paper-input>
		<paper-input minlength=8 label="passphrase" value="{{model.passphrase}}"></paper-input>
		<h3>network settings:</h3>
		<paper-checkbox on-checked-changed="_dhcpChanged" checked={{model.dhcp}}>DHCP client</paper-checkbox>
		<ip-with-mask-input id="staticIP" value="{{model.static.ip}}"></ip-with-mask-input>
		<template is="dom-repeat" items="{{model.dns-servers}}" >
			<gold-ip-input on-change="_dnsChanged" id="dns[[index]]" label="DNS [[_humanIndex(index)]]" value="{{item}}"></gold-ip-input>
		</template>

		<gold-ip-input id="gateway" label="Gateway" value="{{model.static.gateway}}" auto-validate></gold-ip-input>
		<div>
			<paper-button raised on-tap="onSaveTap" disabled=[[!isModified]]>Apply changes</paper-button>
			<paper-button raised on-tap="discardChanges" disabled=[[!isModified]]>Discard</paper-button>
			<template is="dom-if" if="[[_hasDefaults(defaults)]]">
				<paper-button raised on-tap="loadDefaults">Load Defaults</paper-button>
			</template>
			<paper-button raised on-tap="configRemove" disabled=[[!config]]>Delete</paper-button>
		</div>
	</template>

	<script>
		Polymer({
			is: 'wifi-client',

			ready() {
				console.log('ready', this.get('config'), this.get('defaults'));
				if (this.get('defaults')) {
					this.set('_defaults', JSON.stringify(this.get('defaults')));
				}
				if (!this.get('config')) {
					this.loadDefaults();
				}
			},
			_humanIndex(index) {
				return index + 1;
			},

			_dhcpChanged: function (event, element) {
				console.log('_dhcpChanged', event, element);
				// workaround for avoiding error thrown when validating uninitialized input
				if (typeof this.$.staticIP.value === 'string') {
					this.$.staticIP.required = !element.value;
					console.log('staic ip required', !element.value);
				}
				if (typeof this.$.gateway.value === 'string') {
					this.$.gateway.invalid = element.value ? false : !this.$.gateway.validate();
				}
				this.$.gateway.label = element.value ? "Gateway overridden by DHCP" : "Gateway";
				this.$.gateway.disabled = element.value;
			},
			_ownMode: 'client',
			onSaveTap() {
				this.validateAndSave({
					type: 'interfaceUpdate',
					name: this.name,
					enabled: this.enabled,
					mode: this._ownMode,
				});
			},
			properties: {
				isModified: {
					type: Boolean,
					computed: '_isModified(mode, status.isModified, selected)',
					value: false,
				},
				selected: {
					type: String,
					notify: true,
				},
				enabled: {
					type: Boolean,
					value: false,
				},
			},
			observers: [
				'_configChanged(config.*)',
			],
			behaviors: [
				UniFlow.ModelView
			],
			discardChanges() {
				if (this.get('_model')) {
					this.set('model', JSON.parse(this._model));
				} else {
					this.loadDefaults();
				}
				if (this.get('selected') !== this.get('mode')) {
					this.set('selected', this.get('mode'));
				}
			},
			loadDefaults() {
				console.log('loadDefaults', this.get('defaults'));
				if (this.get('_defaults')) {
					this.set('model', JSON.parse(this.get('_defaults')));
					if (this.get('_model') !== this.get('_defaults')) {
						this.set('status.isModified', true);
					}
				} else {
					this.set('model', {});
				}
			},
			configRemove() {
				this.emitAction({
					type: 'configRemove',
					name: this.name,
					mode: this.selected,
				});
			},
			_configChanged(changeRecord) {
				console.log('_configChanged', changeRecord);
				if (this.get('config')) {
					this.set('_model', JSON.stringify(this.config));
					this.set('model', JSON.parse(this._model));
				} else {
					this.loadDefaults();
				}
			},
			_isModified: function() {
				console.log('_isModified', this.get('mode'), this._ownMode);
				return this.get('status.isModified') || (this.get('mode') !== this._ownMode);
			},
			_hasDefaults: function(defaults) {
				return !!defaults;
			},
		});
	</script>
</dom-module>
