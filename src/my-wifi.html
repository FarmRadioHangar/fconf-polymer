<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/gold-ip-input/gold-ip-input.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/uniflow-polymer/action-emitter.html">
<link rel="import" href="wifi-client.html">
<link rel="import" href="wifi-ap.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-wifi">
	<template>
		<style include="shared-styles">
			:host {
				display: block;
			}
		</style>
			<template is="dom-repeat" items="[[system.addresses]]">
				<div>mac: [[item.mac]]<br/> [[item.family]]: [[item.address]] / [[item.netmask]]</div>
			</template>
		ON/OFF
		<paper-toggle-button disabled=[[!isUsable]] on-checked-changed="_enabledChanged" checked="[[enabled]]" notify>[[_ifaceStatus(isUsable, enabled)]] ([[_humanMode(mode)]] mode)</paper-toggle-button>
			Wi-Fi mode: <paper-radio-group selected="{{_selected}}" attr-for-selected="name">
				<template is="dom-if" if="[[client]]"><paper-radio-button name="client">client</paper-radio-button></template>
				<template is="dom-if" if="[[ap]]"><paper-radio-button name="ap">access point</paper-radio-button></template>
			</paper-radio-group>
		<div class="card">
			<template is="dom-if" if="[[_isMode('client', client, _selected)]]">
				<wifi-client
					name=[[name]]
					enabled=[[enabled]]
					config=[[client.config]]
					defaults=[[client.defaults]]
					selected={{_selected}}
					mode=[[mode]]>
				</wifi-client>
			</template>
			<template is="dom-if" if="[[_isMode('ap', ap, _selected)]]">
				<wifi-ap
					name="[[name]]"
					enabled=[[enabled]]
					config=[[ap.config]]
					defaults=[[ap.defaults]]
					selected={{_selected}}
					interfaces=[[interfaces]]
					mode=[[mode]]>
				</wifi-ap>
			</template>
		</div>
	</template>

	<script>
		Polymer({
			is: 'my-wifi',

			_humanMode: function(mode) {
				if (mode === 'ap') {
					return "access point";
				} else {
					return mode;
				}
			},
			_isMode: function(val, mode, selected) {
				return val === selected && this.get(val);
			},
			_ifaceStatus: function(isUsable, enabled) {
				if (isUsable && enabled) {
					return "Enabled";
				} else if (isUsable) {
					return "Disabled";
				} else if (enabled) {
					return "Not found";
				} else {
					return "Not found or unconfigured";
				}
			},
			_systemChanged() {
				if (!this.get('system')) {
					this._setIsUsable(false);
				}
			},
			_modeAp() {
				if (this.get('mode') === 'ap') {
					this._setIsUsable(true);
				}
			},
			_modeClient() {
				if (this.get('mode') === 'client') {
					this._setIsUsable(true);
				}
			},
			_enabledChanged: function (event, element) {
				console.log('_enabledChanged', event, element);
				if (element.value !== this.get('enabled')) {
					this.emitAction({
						type: 'interfaceEnable',
						name: this.name,
						enabled: element.value
					});
					setTimeout(function(value) {
						if (value !== this.get('enabled')) {
							this.set('enabled', this.get('enabled'));
						}
					}.bind(this), 3000, element.value);
				}
			},
			_modeChanged() {
				this.set('_selected', this.get('mode'));
			},
			properties: {
				isUsable: {
					type: Boolean,
					readOnly: true,
					value: false,
				},
				mode: {
					type: String,
					observer: '_modeChanged',
					value: 'client',
				},
				enabled: {
					type: Boolean,
					value: false,
				},
				system: {
					type: Object,
					observer: '_systemChanged',
				}
			},

			observers: [
				'_modeAp(mode, ap.config, system)',
				'_modeClient(mode, client.config, system)',
			],
			behaviors: [
				UniFlow.ModelView
			],
		});
	</script>
</dom-module>
